
<%= link_to 'Back to Dashboard', dashboard_path, class: 'btn btn-secondary' %>

<% if @playlist_songs.count >= 12 %>
  <p class="text-danger">Playlist is full. You cannot add another song.</p>
<% else %>
  <%= link_to 'Add New Song', new_playlist_playlist_song_path(@playlist), class: 'btn btn-primary' %>
<% end %>
<%= link_to 'Edit Playlist Properties', edit_playlist_path(@playlist), class: 'btn btn-primary' %>
<h1><%= @playlist.title %></h1>
<h2>From: <%= @playlist.from_name %></h2>
<h2>To: <%= @playlist.to_name %></h2>
<p><%= @playlist.general_message %></p>

<% if @playlist_songs.any? %>
  <div id="sortable-grid" class="grid-layout">
    <% @playlist_songs.each do |playlist_song| %>
      <div class="grid-item" data-id="<%= playlist_song.id %>">
        <p><%= "#{playlist_song.song.title} - #{playlist_song.song.artist}" %></p>
        <p>Message: <%= playlist_song.message %></p>
        <%= link_to 'Edit', edit_playlist_playlist_song_path(@playlist, playlist_song) %> |
        <%= link_to 'Delete', playlist_playlist_song_path(@playlist, playlist_song), method: :delete, data: { turbo_method: :delete, turbo_confirm: "Are you sure? This will delete the song with your personal message, and CANNOT be reverted!" } %>
      </div>
    <% end %>
  </div>
<% else %>
  <p>No songs in this playlist.</p>
<% end %>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.13.0/Sortable.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function () {
    const el = document.getElementById('sortable-grid');
    if (el) {
      new Sortable(el, {
        animation: 150,
        ghostClass: 'sortable-ghost',
        onEnd: function(evt) {
          let order = this.toArray();

          fetch('/update_playlist_order', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': document.querySelector('[name="csrf-token"]').content
            },
            body: JSON.stringify({ playlist_id: "<%= @playlist.id %>", order: order })
          }).then(response => {
            if (response.ok) {
              console.log('Order updated');
            } else {
              console.error('Error updating order');
            }
          });
        }
      });
    }
  });
</script>

<%= link_to 'Preview Playlist', preview_playlist_path(@playlist), class: 'btn btn-primary' %>
